<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>iframe Window</title>
    <script>
      /*--------------------------------------------------------------------------
     * TrafficJam
     * 2018-10-01
     *///-----------------------------------------------------------------------

      var signature;
      var version = '0.1';
      var api = 'v1';

      function onLander(data) {
        sendToDataCenter(data, 'open-api/{version}/{browser}/landers/{lander}',
          function (response) {
            response.event = 'slugResponse';
            broadcast(response);
          });
      }

      function onStripeToken(data) {
        sendToDataCenter(data, undefined,
          function (response) {
            response.event = 'purchaseResponse';
            broadcast(response);
          });
      }

      function onEmail(data) {
        sendToDataCenter(data, undefined,
          function (response) {
            response.event = 'emailResponse';
            broadcast(response);
          });
      }

      function onHit(data) {
        sendToDataCenter(data);
      }

      function bindEvent(element, eventName, eventHandler) {
        if(element.addEventListener){
          element.addEventListener(eventName, eventHandler, false);
        }else if(element.attachEvent){
          element.attachEvent('on' + eventName, eventHandler);
        }
      }

      function broadcast(data) {
        data.package = 'trafficjam';
        data.version = version;
        data.api = api;

        if(typeof signature != 'undefined'){
          data.browser = signature;
        }

        window.parent.postMessage(JSON.stringify(data), '*');
      }

      function processMessage(e) {

        try{
          var data = JSON.parse(e.data);
          var fnc = 'on';

          if(data.package != 'trafficjam'){
            return;
          }

          fnc += data.event.charAt(0).toUpperCase() + data.event.slice(1);
          window[fnc](data);

        }catch(e){
          //console.log(e.message);
        }

      }

      function sendToDataCenter(data, endpoint, callback) {

        if(typeof signature != 'undefined'){
          data.browser = signature;
        }

        endpoint = (typeof endpoint != 'undefined') ? endpoint : '/open-api/traffic-message';
        endpoint = endpoint.replace('{version}', version);
        var url = '//' + document.location.host.replace('cdn.', '') + endpoint;
        var xmlHttp = new XMLHttpRequest();

        if(typeof callback != 'undefined'){
          xmlHttp.onreadystatechange = function () {
            if(xmlHttp.readyState == 4 && xmlHttp.status == 200){
              callback(JSON.parse(xmlHttp.responseText));
            }

            if(xmlHttp.readyState == 4 && xmlHttp.status == 500){
              callback(JSON.parse(xmlHttp.responseText));
            }

            if(xmlHttp.readyState == 4 && xmlHttp.status != 200){
              //console.log(xmlHttp);
            }

          };
        }

        xmlHttp.open("POST", url, true);
        xmlHttp.setRequestHeader("Access-Control-Allow-Credentials", true);
        xmlHttp.setRequestHeader("Content-Type", "application/json");
        data = JSON.stringify(data);
        xmlHttp.send(data);
      }

      function getFromDataCenter(endpoint, callback) {
        endpoint = endpoint.replace('{version}', version);
        if(typeof signature != undefined){
          endpoint = endpoint.replace('{browser}', signature);
        }

        var url = '//' + document.location.host.replace('cdn.', '') + endpoint;

        var xmlHttp = new XMLHttpRequest();

        if(typeof callback != 'undefined'){
          xmlHttp.onreadystatechange = function () {
            if(xmlHttp.readyState == 4 && xmlHttp.status == 200){
              callback(JSON.parse(xmlHttp.responseText));
            }

            if(xmlHttp.readyState == 4 && xmlHttp.status != 200){
              //console.log(xmlHttp);
            }

          };
        }

        xmlHttp.open("GET", url, true);
        xmlHttp.setRequestHeader("Access-Control-Allow-Credentials", true);
        xmlHttp.setRequestHeader("Content-Type", "application/json");
        xmlHttp.send(null);
      }

      function establishBrowserId() {

        var localStorage = window.localStorage;

        if(localStorage.getItem("trafficjam:signature") === null){
          getFromDataCenter('/open-api/browsers/create', function (response) {
            signature = response.signature;
            localStorage.setItem("trafficjam:signature", signature);
            broadcast({event: 'browser'});
          });

        }else{
          signature = localStorage.getItem("trafficjam:signature");
          broadcast({event: 'browser'});
        }

      }

      document.addEventListener("DOMContentLoaded", function () {
        bindEvent(window, 'message', processMessage);

        setTimeout(establishBrowserId, 500)
      });
    </script>

</head>
<body>
<h1>Terminal</h1>
<div>...</div>
</body>
</html>
